<!DOCTYPE html>
<html>
<head>
  <title>Quotation</title>
  <link rel="stylesheet" href="/static_quote/styles.css?v=999">
</head>
<body data-company='{{ (deal.company_name if deal.company_name is defined else deal.get("company_name","")) | tojson }}'
  data-deal='{{ (deal.deal_id if deal.deal_id is defined else deal.get("deal_id","")) | tojson }}'>

  <div class="container">
    <div class="topbar">
      <a class="link" href="/quote">‚ûï New Deal</a>
      <a class="btn-outline" href="/quote/insights/{{ (deal.deal_id if deal.deal_id is defined else deal.get('deal_id','')) }}">View Insights ‚ú®</a>
    </div>

    <div class="card">
      <h2>üìÑ Quotation</h2>

      <p>
        <b>Deal:</b> {{ deal.deal_id if deal.deal_id is defined else deal.get('deal_id','') }}
        &nbsp; | &nbsp;
        <b>Company:</b> {{ deal.company_name if deal.company_name is defined else deal.get('company_name','') }}
      </p>

      {# ‚úÖ SAFE: get priced items regardless of whether deal is object or dict #}
      {% set items = deal.priced_items if deal.priced_items is defined else (deal.get('priced_items', []) if deal is mapping else []) %}

      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Estimated Unit Price</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for item in items %}
          {# item could be dict or object #}
          {% set product_name = item.product if item.product is defined else item.get('product','') %}
          {% set unit_price = item.unit_price if item.unit_price is defined else item.get('unit_price',0) %}

          <tr data-product="{{ product_name }}">
            <td class="prod-cell">
              {{ product_name }}

              <!-- ‚úÖ small view icon -->
              <button class="icon-btn"
                      type="button"
                      onclick="openProductView('{{ product_name | tojson }}')"
                      title="View">
                üëÅÔ∏è
              </button>
            </td>

            <td>
              <span class="qty" data-product="{{ product_name }}">1</span>
            </td>

            <td>
              ‚Çπ <span class="unit" data-product="{{ product_name }}">{{ '%.2f'|format(unit_price) }}</span>
            </td>

            <td>
              <button class="mini" type="button" onclick='dec({{ product_name | tojson }})'>‚àí</button>
              <button class="mini" type="button" onclick='inc({{ product_name | tojson }})'>+</button>
              <button class="mini danger" type="button" onclick='removeProd({{ product_name | tojson }})'>üóë</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- ‚úÖ modal (outside loop) -->
      <div id="productModal" class="modal hidden">
        <div class="modal-card">
          <button class="modal-close" type="button" onclick="closeProductView()">‚úï</button>

          <h3 id="pm_name"></h3>
          <p><b>Product ID:</b> <span id="pm_id"></span></p>

          <h4>Pros</h4>
          <div id="pm_pros" class="chipbox"></div>

          <h4>Cons</h4>
          <div id="pm_cons" class="chipbox"></div>

          <h4>Graph</h4>
          <div class="graph-placeholder">[Graph will be added by team]</div>

          <h4>Why buy this?</h4>
          <div id="pm_reason" class="reason-box"></div>
        </div>
      </div>

      {% set total = deal.total_price if deal.total_price is defined else (deal.get('total_price',0) if deal is mapping else 0) %}
      <div class="total" id="totalBox">
        Total: ‚Çπ <span id="totalVal">{{ '%.2f'|format(total) }}</span>
      </div>
    </div>
  </div>

<script>
  const companyName = JSON.parse(document.body.dataset.company);
  const dealId = JSON.parse(document.body.dataset.deal);


  function collectProductsExpanded(){
    const rows = document.querySelectorAll("tbody tr[data-product]");
    const list = [];
    rows.forEach(r => {
      const p = r.getAttribute("data-product");
      const qtyEl = r.querySelector(".qty");
      const q = parseInt(qtyEl?.innerText || "1", 10) || 1;
      for(let i=0;i<q;i++) list.push(p);
    });
    return list;
  }

  async function reprice(){
    const productsExpanded = collectProductsExpanded();
    const fd = new FormData();
    fd.append("deal_id", dealId);
    fd.append("company_name", companyName);
    fd.append("products_json", JSON.stringify(productsExpanded));

    const res = await fetch("/quote/reprice", { method:"POST", body: fd });
    const out = await res.json();

    (out.priced_items || []).forEach(it => {
      const p = it.product;
      const unitEls = document.querySelectorAll(`.unit[data-product="${CSS.escape(p)}"]`);
      unitEls.forEach(el => el.innerText = (it.unit_price || 0).toFixed(2));
    });

    document.getElementById("totalVal").innerText = (out.total_price || 0).toFixed(2);
  }

  function inc(p){
    const qtyEl = document.querySelector(`.qty[data-product="${CSS.escape(p)}"]`);
    if(!qtyEl) return;
    qtyEl.innerText = (parseInt(qtyEl.innerText, 10) || 1) + 1;
    reprice();
  }

  function dec(p){
    const qtyEl = document.querySelector(`.qty[data-product="${CSS.escape(p)}"]`);
    if(!qtyEl) return;
    qtyEl.innerText = Math.max(1, (parseInt(qtyEl.innerText, 10) || 1) - 1);
    reprice();
  }

  function removeProd(p){
    const row = document.querySelector(`tr[data-product="${CSS.escape(p)}"]`);
    if(row) row.remove();
    reprice();
  }

  async function openProductView(productName){
    const res = await fetch("/quote/product/view", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ product_name: productName })
    });
    const data = await res.json();

    document.getElementById("pm_name").textContent = data.product_name || productName;
    document.getElementById("pm_id").textContent = data.product_id || "TBD";

    document.getElementById("pm_pros").innerHTML = (data.pros || [])
      .map(x => `<span class="chip">${x}</span>`).join("");
    document.getElementById("pm_cons").innerHTML = (data.cons || [])
      .map(x => `<span class="chip">${x}</span>`).join("");

    document.getElementById("pm_reason").textContent = data.reason_to_buy || "";
    document.getElementById("productModal").classList.remove("hidden");
  }

  function closeProductView(){
    document.getElementById("productModal").classList.add("hidden");
  }
</script>
</body>
</html>
