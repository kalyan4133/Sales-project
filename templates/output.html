<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Structured Output</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/styles.css" />
</head>

<body>
  <div class="page">
    <header class="header">
      <div class="brand">
        <div class="logo">✅</div>
        <div>
          <div class="title">Structured Requirements</div>
          <div class="subtitle">Generated by the agent</div>
        </div>
      </div>
      <div class="header-actions">
        <a class="btn ghost" href="/" style="text-decoration:none;">← Back</a>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Customer</h2>
        <div id="customer" class="kv"></div>
      </section>

      <section class="card">
        <h2>Request Summary</h2>
        <div id="summary" class="para"></div>
      </section>

      <section class="card">
        <h2>Explicit Requirements</h2>
        <div id="explicit" class="list"></div>
      </section>

      <section class="card">
        <h2>Implicit Requirements</h2>
        <div id="implicit" class="list"></div>
      </section>

      <section class="card">
        <h2>Constraints</h2>
        <div id="constraints" class="kv"></div>
      </section>

      <section class="card">
        <h2>Matched Products</h2>
        <div id="products" class="list"></div>
      </section>

      <section class="card">
        <h2>Questions to Ask</h2>
        <div id="gaps" class="list"></div>
      </section>

      <!-- Raw JSON removed for cleaner UI -->
    
<div class="actions" style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
  <button id="toQuoteBtn" class="btn primary" type="button">Go to Quote Generation ➜</button>
  <a class="btn ghost" href="/" style="text-decoration:none;">← Back</a>
</div>

    </main>
  </div>

  <script>
    function toggleProd(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.classList.toggle('open');
    }

    const dataRaw = sessionStorage.getItem("analysisResult");

    if (!dataRaw) {
      document.querySelector(".grid").innerHTML = `
        <section class="card full">
          <h2>No output found</h2>
          <p class="muted">You probably opened /output directly. Go back and click Submit on the input page.</p>
          <a class="btn primary" href="/" style="text-decoration:none;">Go Back</a>
        </section>
      `;
    } else {
      const data = JSON.parse(dataRaw);

      const setKV = (el, obj) => {
        el.innerHTML = "";
        Object.entries(obj || {}).forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "kv-row";
          row.innerHTML = `<div class="kv-k">${k}</div><div class="kv-v">${(v ?? "").toString()}</div>`;
          el.appendChild(row);
        });
        if (!obj || Object.keys(obj).length === 0) el.innerHTML = `<div class="empty">No data</div>`;
      };

      const setList = (el, arr, formatter) => {
        el.innerHTML = "";
        (arr || []).forEach((item, idx) => {
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = formatter(item, idx);
          el.appendChild(card);
        });
        if (!arr || arr.length === 0) el.innerHTML = `<div class="empty">No items found</div>`;
      };

      // Some runs may not have request_summary.one_line populated; fall back to excerpt or first explicit requirement.
      const oneLine = (typeof data?.request_summary === "string")
        ? data.request_summary
        : (data?.request_summary?.one_line || "");
      const excerpt = data?.request_summary?.raw_text_excerpt || "";
      const firstExplicit = (data?.requirements?.explicit?.[0]?.value || "");
      document.getElementById("summary").textContent = (oneLine || excerpt || firstExplicit || "").toString().slice(0, 500);

      setKV(document.getElementById("customer"), {
        company_name: data?.customer?.company_name || "",
        company_seen_before: data?.customer?.company_seen_before ?? ""
      });

      setList(document.getElementById("explicit"), data?.requirements?.explicit, (x) => `
        <div class="item-title">${x.type || "requirement"}: <span class="muted">${x.value || ""}</span></div>
        <div class="item-sub">Evidence: ${x.evidence || "-"} • Confidence: ${x.confidence ?? "-"}</div>
      `);

      setList(document.getElementById("implicit"), data?.requirements?.implicit, (x) => `
        <div class="item-title">${x.type || "inference"}: <span class="muted">${x.value || ""}</span></div>
        <div class="item-sub">Evidence: ${x.evidence || "-"} • Confidence: ${x.confidence ?? "-"}</div>
      `);

      // Remove budget from constraints display (keep other constraints)
      const constraintsObj = data?.requirements?.constraints || {};
      const filteredConstraints = {};
      Object.entries(constraintsObj).forEach(([k,v]) => {
        if (/budget/i.test(k)) return;
        filteredConstraints[k] = v;
      });
      setKV(document.getElementById("constraints"), filteredConstraints);

      setList(document.getElementById("products"), data?.product_matches, (x, idx) => {
  const conf = (x.confidence ?? x.score ?? 0);
  const pct = (typeof conf === "number") ? Math.round(conf * 100) : conf;
  const reasons = (x.match_reason || []).map(r => `<li>${r}</li>`).join("") || "<li>No explainability available</li>";
  const accId = `prod-acc-${idx}`;
  return `
    <div class="item-row">
      <div>
        <div class="item-title">${x.product_name || "Product"}</div>
        <div class="item-sub">Match Score: <strong>${pct}%</strong></div>
      </div>
      <button class="acc-btn" type="button" onclick="toggleProd('${accId}')">▾</button>
    </div>
    <div class="acc-panel" id="${accId}">
      <div class="muted" style="margin-bottom:6px;">Why this was recommended</div>
      <ul class="acc-list">${reasons}</ul>
    </div>
  `;
});

      setList(document.getElementById("gaps"), data?.gaps_and_questions, (x) => `
        <div class="item-title">${x.missing_field || "Missing"} <span class="muted">(${x.priority || "medium"})</span></div>
        <div class="item-sub">${x.question_to_ask || ""}</div>
      `);

      // raw json removed
    }
  </script>

<script>
  const btn = document.getElementById("toQuoteBtn");
  btn?.addEventListener("click", () => {
    const dataRaw = sessionStorage.getItem("analysisResult");
    if(!dataRaw){ window.location.assign("/"); return; }
    const data = JSON.parse(dataRaw);

    const company = (data?.customer?.company_name || "").trim();
    const productsArr = (data?.product_matches || []).map(x => (x?.product_name || "").trim()).filter(Boolean);

    // generate stable-ish deal id for demo
    const existing = sessionStorage.getItem("dealId");
    const dealId = existing || ("D" + Date.now().toString().slice(-6));
    sessionStorage.setItem("dealId", dealId);

    const productsJson = encodeURIComponent(JSON.stringify(productsArr));
    const cname = encodeURIComponent(company);
    const did = encodeURIComponent(dealId);

    window.location.assign(`/quote?deal_id=${did}&company_name=${cname}&products_json=${productsJson}`);
  });
</script>

</body>
</html>
